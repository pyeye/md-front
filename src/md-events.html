<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-styles/typography.html">

<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">

<link rel="import" href="../bower_components/neon-animation/neon-shared-element-animatable-behavior.html">
<link rel="import" href="../bower_components/neon-animation/animations/hero-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/ripple-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-out-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-in-animation.html">

<link rel="import" href="../bower_components/app-storage/app-localstorage/app-localstorage-document.html">


<link rel="import" href="md-icons.html">


<dom-module id="md-events">

  <template>

  <style>
  :host {
    display: block;
    position: absolute;
    left: 0;
    height: 100vh;
  }

  app-header {
    background-color: var(--app-primary-color);
    color: #fff;
    --app-header-background-front-layer: {
      background-image: url(http://146.185.165.166/img/static/homepage/мероприятия3.jpg);
      background-position: center center;
    };
  }

  app-toolbar.tall {
    height: 176px;
  }

  sample-content {
    padding-top: 212px;
  }

  [main-title] {
    font-weight: normal;
    margin-left: 50px;

  }

  [condensed-title] {
    font-weight: normal;
    margin-left: 5px;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  [condensed-title] i {
    font-weight: 100;
    font-style: normal;
  }

  @media (max-width: 639px) {
    [main-title] {
      margin-left: 50px;
      font-size: 30px;
    }
    [condensed-title] {
      font-size: 24px;
    }
  }

  app-toolbar {
    color: white;
  }

  .content {
    @apply(--layout-horizontal);
  }

  .special-list {
    width: 40%;
    margin:auto;
    margin-top: 16px;

  }

  .news-title-casting {
    position: absolute;
    width: 35%;
    bottom: 0;
    left: 0;
    top: 0;
    background: rgba(0,0,0,0.6);
    color: white;
    padding: 20px;
    @apply(--paper-font-subhead);
  }

  .news-title-jazz {
    position: absolute;
    width: 35%;
    bottom: 0;
    left: 0;
    top: 0;
    background: rgba(230, 81, 0,0.6);
    color: white;
    padding: 20px;
    @apply(--paper-font-subhead);
  }

  .news-title-stand-up {
    position: absolute;
    width: 35%;
    bottom: 0;
    left: 0;
    top: 0;
    background: rgba(183, 28, 28,0.6);
    color: white;
    padding: 20px;
    @apply(--paper-font-subhead);
  }

  .events-list {
    width: 60%;
    margin: 16px auto;
  }

  .events-material {
    position: relative;
    width: 80%;
    margin: 16px auto;
  }

  .material-news {
    position: relative;
    width: 90%;
    margin-right: auto;
    height: 170px;
  }

  @media (max-width: 745px) {
    .special-list {
      width: 100%;
    }

    app-toolbar.tall {
      height: 146px;
    }
  }

  paper-material {
    margin-top: 16px;
  }

  .event {
    position: relative;
    @apply(--layout-horizontal);
    cursor: pointer;
    padding: 16px 22px;
    border-bottom: 1px solid #191919;
    background-color: #252525;
  }

  .artist-container {
    @apply(--layout-horizontal);
  }

  .artist-title {
    @apply(--paper-font-subhead);
    text-decoration: none;
    color: var(--app-primary-color);
    margin-right: 8px;
  }

  .artist-box {
    @apply(--layout-vertical);
    margin-right: 16px;
  }

  .event-date {
    @apply(--layout-vertical);
    @apply(--paper-font-title);
    width: 20%;
    min-width: 100px;
    color: var(--app-primary-color);
    text-align: center;
    margin-top: auto;
    margin-bottom: auto;
  }

  .event-date-soon {
    @apply(--paper-font-headline);
  }

  .event-date-weekday {
    @apply(--paper-font-subhead);
    font-size: 15px;
  }

  .event-date-day {
    @apply(--paper-font-display1);
    font-size: 38px;
  }

  .event-date-month {
    @apply(--paper-font-subhead);
    font-size: 15px;
  }

  .event-title {
    padding: 16px;
    @apply(--paper-font-display2);
    color: #FFFFFF;
  }

  .pad {
    @apply(--layout-flex);
    @apply(--layout-vertical);
    padding: 0 16px;
    margin-top: auto;
    margin-bottom: auto;
  }

  .artist-name {
    @apply(--paper-font-subhead);
    color: #FFFFFF;
  }

  .artist-style {
    @apply(--paper-font-body1);
    color: #FFFFFF;
    opacity: 0.7;
  }

  .primary {
    @apply(--paper-font-headline);
    color: #FFFFFF;
    font-size: 26px;
  }

  .secondary {
    @apply(--paper-font-subhead);
    color: #FFFFFF;
    opacity: 0.7;
    display: block; /* Fallback for non-webkit */
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  a {
    text-decoration: none;
  }

  paper-ripple {
    color: var(--app-primary-color);
  }

  .news-image {
    position: relative;
    min-height: 170px;
    height: 100%;
    width: 100%;
    max-width: 400px;

    background-color: #252525;
  }

  #ripple {
    position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        width: 100vw;
        background-color: var(--app-lower-layer-color);
        z-index: -5;
  }

  </style>
  <app-header id="header" condenses reveals  effects="waterfall resize-title blend-background parallax-background">
    <app-toolbar>
      <content select="[drawer-toggle]"></content>
      <h3 condensed-title>События</h3>
    </app-toolbar>
    <app-toolbar class="tall">
      <h1 main-title>События</h1>
    </app-toolbar>
  </app-header>

  <iron-ajax id="ajax"
             url="http://146.185.165.166:80/api/v1/events/"
             handle-as="json"
             on-response="handleResponse"></iron-ajax>

  <app-localstorage-document key="events" data={{events}}></app-localstorage-document>

  <div id="ripple"></div>
  <div id="content" class="content">
    <div class="events-list">
    <paper-material class="events-material">
      <template is="dom-repeat" items="[[events]]">
          <a href="#/event/[[item.pk]]">
            <div class="event" on-tap="_heroAnimationHandler">
              <div class="event-date">
                <template is="dom-if" if="[[_shouldRenderDate(item.date)]]">
                    <div class="event-date-soon">[[item.date.soon]]</div>
                </template>
                <template is="dom-if" if$="[[!_shouldRenderDate(item.date)]]">
                  <div class="event-date-weekday">[[item.date.weekday]]</div>
                  <div class="event-date-day">[[item.date.day]]</div>
                  <div class="event-date-month">[[item.date.month]]</div>
                </template>
              </div>
              <div class="pad">
                <div class="primary">[[item.name]]</div>
                <div class="secondary">Stand Up | Вход по билетам</div>
              </div>
              <paper-ripple></paper-ripple>
            </div>
          </a>

      </template>
      </paper-material>
    </div>
    <div class="special-list">
        <paper-material class="material-news">
          <iron-image class="news-image" sizing="cover" preload fade src="http://146.185.165.166/img/static/events/casting.jpg"></iron-image>
          <div class="news-title-casting">
            <div class="news-date">
              Каждую среду
            </div>
            <div class="news-date">
              18:00
            </div>
            <div class="news-info">
              Кастинг молодых исполнителей
            </div>
          </div>
        </paper-material>
        <paper-material class="material-news">
          <iron-image class="news-image" sizing="cover" preload fade src="http://146.185.165.166/img/static/events/jazz.jpg"></iron-image>
          <div class="news-title-jazz">
            <div class="news-date">
              Каждый четверг
            </div>
            <div class="news-date">
              21:00
            </div>
            <div class="news-info">
              Джазовый вечер
            </div>
          </div>
        </paper-material>
        <paper-material class="material-news">
          <iron-image class="news-image" sizing="cover" preload fade src="http://146.185.165.166/img/static/events/stand_up.jpg"></iron-image>
          <div class="news-title-stand-up">
            <div class="news-date">
              Каждое воскресенье
            </div>
            <div class="news-date">
              21:00
            </div>
            <div class="news-info">
              Stand Up выступления
            </div>
          </div>
        </paper-material>
    </div>
  </div>

</template>

<script>

Polymer({

  is: 'md-events',

  properties: {

    events: {
      type: Array
    },

    animationConfig: {
      value: function() {
        return {
          'entry': [
            {
              name: 'ripple-animation',
              id: 'events-ripple',
              toPage: this,
            }, {
              name: 'hero-animation',
              id: 'events-hero',
              toPage: this,
            }, {
              name: 'fade-in-animation',
              node: this.$.content,
              timing: {delay: 150},
            }],
          'exit': [
            {
              name: 'fade-out-animation',
              node: this,
            }, {
              name: 'ripple-animation',
              id: 'event-ripple',
              fromPage: this,
            }]
        }
      }
    },

    sharedElements: {
      value: function() {
        return {
          'events-hero': this.$.header,
          'events-ripple': this.$.ripple,
        }
      }
    },
  },

  listeners: {
    'md-render-neon-page': '_renderNeonPage',
  },

  _heroAnimationHandler: function(e) {
    this.sharedElements['event-ripple'] = e.currentTarget;
  },

  _renderNeonPage: function(e) {
      this.$.ajax.generateRequest();
      layout = document.createElement('app-header-layout');
      layout.id = "layout";
      childNodes = Polymer.dom(this.root).childNodes;
      for (var i = 0; i < childNodes.length; i++) {
        Polymer.dom(layout).appendChild(childNodes[i]);
      }
      Polymer.dom(this.root).appendChild(layout);
      this.unlisten(this, 'md-render-neon-page', '_renderNeonPage');
  },

  _shouldRenderDate: function(date) {
    return !!date.soon;
  },

  behaviors: [
    Polymer.NeonSharedElementAnimatableBehavior,
    Polymer.IronResizableBehavior],

  handleResponse: function(request) {
    var response = request.detail.response;
    var index, len, date, today;
    var options = {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      weekday: 'long',
    };
    for (index = 0, len = response.length; index < len; ++index) {
      response[index].start = response[index].start.slice(0, -3);
      if(response[index].price == 0) {
        response[index].price = 'Свободный';
      }
      date = new Date(response[index].date);
      today = new Date();
      today = today.toLocaleString("ru", options).split(' ');
      date = date.toLocaleString("ru", options).split(' ');
      response[index].date = {
        'weekday': date[0].slice(0, -1),
        'day': date[1],
        'month': date[2],
        'year': date[3],
        'original': response[index].date,
      };

      if(date[1] === today[1] && date[2] === today[2]) {
        response[index].date['soon'] = 'Сегодня';
      } else if(date[1] == (parseInt(today[1]) + 1) && date[2] === today[2]) {
        response[index].date['soon'] = 'Завтра';
      }
    };
    this.events = response;
  },

});

</script>

</dom-module>
