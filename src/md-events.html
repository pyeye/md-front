<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-styles/typography.html">

<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">

<link rel="import" href="../bower_components/neon-animation/neon-shared-element-animatable-behavior.html">
<link rel="import" href="../bower_components/neon-animation/animations/hero-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/ripple-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-out-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-in-animation.html">


<link rel="import" href="md-icons.html">


<dom-module id="md-events">

  <template>

  <style>
  :host {
    display: block;
    position: absolute;
    left: 0;
    height: 100vh;
  }

  app-header {
    background-color: var(--app-primary-color);
    color: #fff;
    --app-header-background-front-layer: {
      background-image: url(http://localhost/img/static/homepage/мероприятия3.jpg);
      background-position: center center;
    };
  }

  app-toolbar.tall {
    height: 176px;
  }

  sample-content {
    padding-top: 212px;
  }

  [main-title] {
    font-weight: normal;
    margin-left: 50px;

  }

  [condensed-title] {
    font-weight: normal;
    margin-left: 5px;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  [condensed-title] i {
    font-weight: 100;
    font-style: normal;
  }

  @media (max-width: 639px) {
    [main-title] {
      margin-left: 50px;
      font-size: 30px;
    }
    [condensed-title] {
      font-size: 24px;
    }
  }

  app-toolbar {
    color: white;
  }

  .special-list {
    width: 65%;
    margin:auto;
    margin-bottom: 16px;
  }

  @media (max-width: 745px) {
    .special-list {
      width: 100%;
    }

    app-toolbar.tall {
      height: 146px;
    }
  }

  paper-material {
    margin-top: 16px;
    border-radius: 5px;
  }

  .event {
    position: relative;
    @apply(--layout-horizontal);
    cursor: pointer;
    padding: 16px 22px;
    border-bottom: 1px solid #191919;
    background-color: #272727;
  }

  .artist-container {
    @apply(--layout-horizontal);

  }

  .artist-title {
    @apply(--paper-font-subhead);
    text-decoration: none;
    color: var(--app-primary-color);
    margin-right: 8px;
  }

  .artist-box {
    @apply(--layout-vertical);
    margin-right: 16px;
  }

  .event-date {
    @apply(--layout-vertical);
    @apply(--paper-font-title);
    width: 15%;
    min-width: 90px;
    color: var(--app-primary-color);
    text-align: center;
    margin-top: auto;
    margin-bottom: auto;

  }

  .event-date-soon {
    @apply(--paper-font-headline);

  }

  .event-date-weekday {
    @apply(--paper-font-subhead);
  }

  .event-date-day {
    @apply(--paper-font-display3);
    font-size: 50px;
  }

  .event-date-month {
    @apply(--paper-font-subhead);
  }

  .event-title {
    padding: 16px;
    @apply(--paper-font-display1);
    color: #FFFFFF;
  }

  .pad {
    @apply(--layout-flex);
    @apply(--layout-vertical);
    padding: 0 16px;
  }

  .artist-name {
    @apply(--paper-font-subhead);
    color: #FFFFFF;
  }

  .artist-style {
    @apply(--paper-font-body1);
    color: #FFFFFF;
    opacity: 0.7;
  }

  .primary {
    @apply(--paper-font-headline);
    color: var(--app-primary-color);
  }

  .secondary {
    @apply(--paper-font-body1);
    color: #FFFFFF;
    opacity: 0.7;
    font-size: 14px;
    margin-bottom: 8px;
    display: block; /* Fallback for non-webkit */
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  a {
    text-decoration: none;
  }

  paper-ripple {
    color: var(--app-primary-color);
  }

  #ripple {
    position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        width: 100vw;
        background-color: var(--app-lower-layer-color);
        z-index: -5;
  }

  </style>
  <app-header id="header" condenses reveals  effects="waterfall resize-title blend-background parallax-background">
    <app-toolbar>
      <content select="[drawer-toggle]"></content>
      <h3 condensed-title>События</h3>
    </app-toolbar>
    <app-toolbar class="tall">
      <h1 main-title>События</h1>
    </app-toolbar>
  </app-header>

  <iron-ajax auto
             url="http://localhost:80/api/v1/events/?special=true"
             handle-as="json"
             on-response="handleSpecialResponse"></iron-ajax>

  <iron-ajax auto
             url="http://localhost:80/api/v1/events/?regular=true"
             handle-as="json"
             on-response="handleRegularResponse"></iron-ajax>


  <div id="ripple"></div>
  <div id="content">
    <template is="dom-if" if="[[showSpecial]]">
      <div class="special-list">
        <div class="event-title">
          Не пропустите
        </div>
          <template is="dom-repeat" items="[[specialEvents]]">
            <paper-material id$="r_[[item.pk]]" on-tap="_heroAnimationHandler">
              <a href="#/event/[[item.pk]]">
                <div class="event">
                  <div class="event-date">
                    <div class="event-date-weekday">[[item.date.weekday]]</div>
                    <div class="event-date-soon">[[item.date.soon]]</div>
                    <div class="event-date-day">[[item.date.day]]</div>
                    <div class="event-date-month">[[item.date.month]]</div>
                  </div>
                  <div class="pad">
                    <div class="primary">[[item.name]]</div>
                    <div class="secondary">[[item.info]]</div>
                    <div class="artist-container">
                      <div class="artist-title">
                        Артисты:
                      </div>
                      <template is="dom-repeat" items="{{item.artists}}" as="artist">
                        <div class="artist-box">
                          <div class="artist-name">
                            [[artist.name]]
                          </div>
                          <div class="artist-style">
                            [[artist.style]]
                          </div>
                        </div>
                      </template>
                    </div>
                  </div>
                  <paper-ripple></paper-ripple>
                </div>
              </a>
            </paper-material>
          </template>
      </div>
    </template>

    <div class="special-list">
      <div class="event-title">
        Ближайшие мероприятия
      </div>
      <template is="dom-repeat" items="[[regularEvents]]">
        <paper-material id$="r_[[item.pk]]" on-tap="_heroAnimationHandler">
          <a href="#/event/[[item.pk]]">
            <div class="event">
              <div class="event-date">
                <div class="event-date-weekday">[[item.date.weekday]]</div>
                <div class="event-date-soon">[[item.date.soon]]</div>
                <div class="event-date-day">[[item.date.day]]</div>
                <div class="event-date-month">[[item.date.month]]</div>
              </div>
              <div class="pad">
                <div class="primary">[[item.name]]</div>
                <div class="secondary">[[item.info]]</div>
                <div class="artist-container">
                  <div class="artist-title">
                    Артисты:
                  </div>
                  <template is="dom-repeat" items="{{item.artists}}" as="artist">
                    <div class="artist-box">
                      <div class="artist-name">
                        [[artist.name]]
                      </div>
                      <div class="artist-style">
                        [[artist.style]]
                      </div>
                    </div>
                  </template>
                </div>
              </div>
              <paper-ripple></paper-ripple>
            </div>
          </a>
        </paper-material>
      </template>
    </div>
  </div>

</template>

<script>

Polymer({

  is: 'md-events',

  properties: {
    day: {
      type: String,
      computed: 'computeDate(item.date)',
    },

    specialEvents: {
      type: Array
    },

    showSpecial: {
      type: Boolean,
      value: false,
    },

    regularEvents: {
      type: Array
    },

    active: {
      type: Boolean,
      value: false,
      reflectToAttribute: true
    },

    animationConfig: {
      value: function() {
        return {
          'entry': [
            {
              name: 'ripple-animation',
              id: 'events-ripple',
              toPage: this,
            }, {
              name: 'hero-animation',
              id: 'events-hero',
              toPage: this,
            }, {
              name: 'fade-in-animation',
              node: this.$.content,
              timing: {delay: 150},
            }],
          'exit': [
            {
              name: 'fade-out-animation',
              node: this,
            }, {
              name: 'ripple-animation',
              id: 'event-ripple',
              fromPage: this,
            }]
        }
      }
    },

    sharedElements: {
      value: function() {
        return {
          'events-hero': this.$.header,
          'events-ripple': this.$.ripple,
        }
      }
    },
  },

  listeners: {
    'md-render-neon-page': '_renderNeonPage',
  },

  _heroAnimationHandler: function(e) {
    this.sharedElements['event-ripple'] = e.currentTarget;
  },

  _renderNeonPage: function(e) {
      layout = document.createElement('app-header-layout');
      layout.id = "layout";
      childNodes = Polymer.dom(this.root).childNodes;
      for (var i = 0; i < childNodes.length; i++) {
        Polymer.dom(layout).appendChild(childNodes[i]);
      }
      Polymer.dom(this.root).appendChild(layout);
      this.unlisten(this, 'md-render-neon-page', '_renderNeonPage');
  },

  behaviors: [
    Polymer.NeonSharedElementAnimatableBehavior,
    Polymer.IronResizableBehavior],

  handleSpecialResponse: function(request) {
    this.specialEvents = this._handleResponse(request.detail.response);
    this.showSpecial = this.specialEvents.length > 0 ? true : false;
  },

  handleRegularResponse: function(request) {
    this.regularEvents = this._handleResponse(request.detail.response);
  },

  _handleResponse: function(response) {
    var index, len, date, today;
    var options = {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      weekday: 'long',
    };
    for (index = 0, len = response.length; index < len; ++index) {
      response[index].start = response[index].start.slice(0, -3);
      if(response[index].price == 0) {
        response[index].price = 'Свободный';
      } else {
        response[index].price += ' &#x20bd;'
      }
      date = new Date(response[index].date);
      today = new Date();
      today = today.toLocaleString("ru", options).split(' ');
      date = date.toLocaleString("ru", options).split(' ');
      if(date[1] === today[1] && date[2] === today[2]) {
        response[index].date = {
          'soon': 'Сегодня',
        };
      } else if(date[1] == (parseInt(today[1]) + 1) && date[2] === today[2]) {
        response[index].date = {
          'soon': 'Завтра',
        };
      } else {
        response[index].date = {
          'weekday': date[0].slice(0, -1),
          'day': date[1],
          'month': date[2],
          'year': date[3],
          'original': response[index].date,
        };
      }
    };
    return response;
  },

  computeDate: function(date) {
    return date.split('-')[0];
  },
});

</script>

</dom-module>
